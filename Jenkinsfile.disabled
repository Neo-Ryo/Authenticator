pipeline {
    agent{
        label "Crait"
    }

    environment {
        NEXUS_ADR = "nexus.neomanis.bzh:8443"
        IMAGE_NAME = sh (returnStdout: true, script: '''
            image=$(echo "${JOB_NAME}"| cut -d"/" -f2| tr "[:upper:]" "[:lower:]")
            echo "$image"
            ''').trim()
        
        // ex: VER_DEV = mondepot/dev-21.07.31-commitid
        VER_DEV = sh (returnStdout: true, script: '''
            date=$(date +"%Y.%m.%d")
            commit=$(echo "${GIT_COMMIT}"| head -c 10)
            echo "-dev:$date-$commit"
            ''').trim()
        // ex: VER_DEV = mondepot/latest
        VER_MAIN = sh (returnStdout: true, script: '''
            echo ":latest"
            ''').trim()
    }
	stages {
/*
        stage ('Pre-Build') {
            steps{
                sh 'echo "Pre-Building..."'
                // Check Version
                sh 'docker --version'
            }
        }

    stage ('Test-main') {
            when{
				branch 'main'
			}
            steps{
                echo "${env.VER_MAIN}"
                sh "echo '${env.VER_MAIN}'"
                sh "echo '${env.IMAGE_NAME}'"
            }
        }

    stage ('Test-dev') {
            when{
				branch 'dev'
			}
            steps{
                echo "${env.VER_DEV}"
                sh "echo '${env.VER_DEV}'"
            }
        }
*/

		stage ('Build-if-Main') {
            when{
				branch 'main'
			}
            steps{
                sh 'echo "Building..."'
                // Launch Build
                sh "sudo docker build --tag ${env.IMAGE_NAME}${env.VER_MAIN} ."
                // Check Result
                sh "sudo docker image ls ${env.IMAGE_NAME}${env.VER_MAIN}"
                sh 'echo "Builded!"'
            }
		}
        stage ('Store-if-Main') {
            when{
				branch 'main'
			}
            steps{
			sh 'echo "Go to the Registry!"'
            sh "sudo docker tag ${env.IMAGE_NAME}${env.VER_MAIN} ${env.NEXUS_ADR}/${env.IMAGE_NAME}${env.VER_MAIN}"
            sh "sudo docker push ${env.NEXUS_ADR}/${env.IMAGE_NAME}${env.VER_MAIN}"
            sh 'echo "Update to the store... OK!"'
			}
		}
        stage ('Clean-if-Main') {
            when{
				branch 'main'
			}
            steps{
                sh 'echo "Cleaning last build"'
                // Launch Build
                sh "sudo docker image rm ${env.NEXUS_ADR}/${env.IMAGE_NAME}${env.VER_MAIN}"
                sh "sudo docker image rm ${env.IMAGE_NAME}${env.VER_MAIN}"
                sh 'echo "Clean!"'
            }
		}
       

        stage ('Build-if-Dev') {
            when{
				branch 'dev'
			}
            steps{
                sh 'echo "Building..."'
                // Launch Build
                sh "sudo docker build --tag ${env.IMAGE_NAME}${env.VER_DEV} ."
                // Check Result
                sh "sudo docker image ls ${env.IMAGE_NAME}${env.VER_DEV}"
                sh 'echo "Builded!"'
            }
		}
		stage ('Store-if-Dev') {
            when{
				branch 'dev'
			}
            steps{
			sh 'echo "Go to the Registry!"'
			//avec num��ro de version
            sh "sudo docker tag ${env.IMAGE_NAME}${env.VER_DEV} nexus.neomanis.bzh:8443/${env.IMAGE_NAME}${env.VER_DEV}"
            sh "sudo docker push ${env.NEXUS_ADR}/${env.IMAGE_NAME}${env.VER_DEV}"
            //version latest
            sh "sudo docker tag ${env.IMAGE_NAME}${env.VER_DEV} nexus.neomanis.bzh:8443/${env.IMAGE_NAME}-dev:latest"
            sh "sudo docker push ${env.NEXUS_ADR}/${env.IMAGE_NAME}-dev:latest"
            sh 'echo "Update to the store... OK!"'
			}
		}
		stage ('Clean-if-Dev') {
            when{
				branch 'dev'
			}
            steps{
                sh 'echo "Cleaning last build"'
                // Launch Build
                sh "sudo docker image rm ${env.NEXUS_ADR}/${env.IMAGE_NAME}${env.VER_DEV}"
                sh "sudo docker image rm ${env.NEXUS_ADR}/${env.IMAGE_NAME}-dev:latest"
                sh "sudo docker image rm ${env.IMAGE_NAME}${env.VER_DEV}"
                sh 'echo "Clean!"'
            }
		}

        stage ('Start CICD NeoServer') {
            steps{
			//sh 'echo "Launch CICD Docker-Compose_NeoServer!"'
            build job: '/Neo_BZH/Docker-Compose_NeoSolution/main', wait: false
            //sh 'echo "And Finish!"'
			}
		}

        
    }
}
